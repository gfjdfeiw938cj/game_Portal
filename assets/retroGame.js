import"./modulepreload-polyfill.js";function e(e,t){switch(!0){case e===0:return`top-left`;case e<t-1:return`top`;case e===t-1:return`top-right`;case e===t**2-1:return`bottom-right`;case(e+1)%t===0:return`right`;case e>t**2-t:return`bottom`;case e===t**2-t:return`bottom-left`;case e%t===0:return`left`;default:return`center`}}function t(e){return e<15?`critical`:e<50?`normal`:`high`}var n=class{constructor(){this.boardSize=8,this.container=null,this.popup=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw Error(`container is not HTMLElement`);this.container=e}bindPopup(e){if(!(e instanceof HTMLElement))throw Error(`container is not HTMLElement`);this.popup=e}drawUi(t){this.checkBinding(),this.container.innerHTML=`
      <div class="controls">
        <button data-id="action-restart" class="btn">New Game</button>
        <button data-id="action-save" class="btn">Save Game</button>
        <button data-id="action-load" class="btn">Load Game</button>
      </div>
      <div class="board-container">
        <div data-id="board" class="board"></div>
      </div>
    `,this.newGameEl=this.container.querySelector(`[data-id=action-restart]`),this.saveGameEl=this.container.querySelector(`[data-id=action-save]`),this.loadGameEl=this.container.querySelector(`[data-id=action-load]`),this.popupCloseButton=this.popup.querySelector(`.popup__button`),this.newGameEl.addEventListener(`click`,e=>this.onNewGameClick(e)),this.saveGameEl.addEventListener(`click`,e=>this.onSaveGameClick(e)),this.loadGameEl.addEventListener(`click`,e=>this.onLoadGameClick(e)),this.popupCloseButton.addEventListener(`click`,()=>this.closePopup()),this.boardEl=this.container.querySelector(`[data-id=board]`),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){let n=document.createElement(`div`);n.classList.add(`cell`,`map-tile`,`map-tile-${e(t,this.boardSize)}`),n.addEventListener(`mouseenter`,e=>this.onCellEnter(e)),n.addEventListener(`mouseleave`,e=>this.onCellLeave(e)),n.addEventListener(`click`,e=>this.onCellClick(e)),this.boardEl.appendChild(n)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(let e of this.cells)e.innerHTML=``;for(let n of e){let e=this.boardEl.children[n.position],r=document.createElement(`div`);r.classList.add(`character`,n.character.type);let i=document.createElement(`div`);i.classList.add(`health-level`);let a=document.createElement(`div`);a.classList.add(`health-level-indicator`,`health-level-indicator-${t(n.character.health)}`),a.style.width=`${n.character.health}%`,i.appendChild(a),r.appendChild(i),e.appendChild(r)}}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();let t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach(e=>e.call(null,t))}onCellLeave(e){e.preventDefault();let t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach(e=>e.call(null,t))}onCellClick(e){let t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach(e=>e.call(null,t))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach(e=>e.call(null))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach(e=>e.call(null))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach(e=>e.call(null))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t=`yellow`){this.deselectCell(e),this.cells[e].classList.add(`selected`,`selected-${t}`)}deselectCell(e){let t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter(e=>e.startsWith(`selected`)))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=``}showDamage(e,t){return new Promise(n=>{let r=this.cells[e],i=document.createElement(`span`);i.textContent=t,i.classList.add(`damage`),r.appendChild(i),i.addEventListener(`animationend`,()=>{r.removeChild(i),n()})})}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(this.container===null)throw Error(`GamePlay not bind to DOM`)}closePopup(){this.popup.classList.add(`popup_hidden`)}showPopup(e){let t=this.popup.querySelector(`.popup__title`);t.textContent=e,this.popup.classList.remove(`popup_hidden`)}},r={prairie:`prairie`,desert:`desert`,arctic:`arctic`,mountain:`mountain`},i={auto:`auto`,pointer:`pointer`,crosshair:`crosshair`,notallowed:`not-allowed`},a={COMP:`computer`,USER:`user`},o=class e{static from(t){let{stage:n,teams:r,motion:i,scores:a}=t;return new e(n,r,i,a)}constructor(e,t,n,r){this.stage=e,this.teams=t,this.motion=n,this.scores=r||0,this.availableSteps=null,this.availableAttack=null,this.selectedHero=null}clear(){this.availableSteps=null,this.availableAttack=null,this.selectedHero=null}removeHero(e){this.teams=this.teams.filter(t=>t.position!==e)}addScores(){let e=this.teams.reduce((e,t)=>t.character.player===`user`?e+t.character.health:e,0);this.scores+=e}},s=class{constructor(e,t,n,r,i,a){if(this.level=e,this.attack=t,this.defence=n,this.health=100,this.player=r,this.stepsRadius=i,this.attackRadius=a,new.target.name===`Character`)throw Error(`Запрещено создавать объекты базового класса Character!`)}},c=class{constructor(e,t){if(!(e instanceof s))throw Error(`character must be instance of Character or its children`);if(typeof t!=`number`)throw Error(`position must be a number`);this.character=e,this.position=t}},l={[a.USER]:{Bowman:{attack:25,defence:25,stepsRadius:2,attackRadius:2},Magician:{attack:10,defence:40,stepsRadius:1,attackRadius:3},Swordsman:{attack:40,defence:10,stepsRadius:3,attackRadius:1}},[a.COMP]:{Daemon:{attack:10,defence:40,stepsRadius:1,attackRadius:3},Undead:{attack:40,defence:10,stepsRadius:3,attackRadius:1},Vampire:{attack:25,defence:25,stepsRadius:2,attackRadius:2}}},u=class extends s{constructor(e){let{attack:t,defence:n,stepsRadius:r,attackRadius:i}=l[a.USER].Bowman,o=a.USER;super(e,t,n,o,r,i),super.type=`bowman`}},d=class extends s{constructor(e){let{attack:t,defence:n,stepsRadius:r,attackRadius:i}=l[a.COMP].Daemon,o=a.COMP;super(e,t,n,o,r,i),super.type=`daemon`}},f=class extends s{constructor(e){let{attack:t,defence:n,stepsRadius:r,attackRadius:i}=l[a.USER].Magician,o=a.USER;super(e,t,n,o,r,i),super.type=`magician`}},p=class extends s{constructor(e){let{attack:t,defence:n,stepsRadius:r,attackRadius:i}=l[a.USER].Swordsman,o=a.USER;super(e,t,n,o,r,i),super.type=`swordsman`}},m=class extends s{constructor(e){let{attack:t,defence:n,stepsRadius:r,attackRadius:i}=l[a.COMP].Undead,o=a.COMP;super(e,t,n,o,r,i),super.type=`undead`}},h=class extends s{constructor(e){let{attack:t,defence:n,stepsRadius:r,attackRadius:i}=l[a.COMP].Vampire,o=a.COMP;super(e,t,n,o,r,i),super.type=`vampire`}},g=class{constructor(){this.members=new Set}add(e){this.members.add(e)}get toArray(){return[...this.members]}};function _(e,t){let n=Math.floor(Math.random()*e.length),r=Math.floor(Math.random()*t)+1;return new e[n](r)}function v(e,t,n){let r=new g;for(let i=0;i<n;i+=1)r.add(_(e,t));return r}function y(e,t){let n=[],r=e===a.USER?0:6;for(let e=r;e<=63;e+=8)n.push(e,e+1);let i=Math.floor(Math.random()*n.length);return t.some(e=>e==n[i])?y(e,t):(t.push(n[i]),n[i])}function b(e,t){let n=new Set,r=e,i=e,a=e,o=e;for(;r>e-t*8&&r-8>=0;)r-=8;for(;i<e+t*8&&i+8<64;)i+=8;for(;a>e-t&&a%8!=0;)--a;for(;o<e+t&&(o+1)%8!=0;)o+=1;for(let e=a;e<=o;e+=1)n.add(e);for(let e=r;e<=i;e+=8)n.add(e);for(let r=e;r>=e-t*9&&(n.add(r),!(r%8==0||r-8<0));r-=9);for(let r=e;r<=e+t*9&&(n.add(r),!((r+1)%8==0||r+8>64));r+=9);for(let r=e;r>=e-7*t&&(n.add(r),!((r+1)%8==0||r-7<0));r-=7);for(let r=e;r<=e+t*7&&(n.add(r),!(r%8==0||r+7>=64));r+=7);return[...n].filter(t=>t!==e)}function x(e,t){let n=new Set,r=e,i=e,a=null;for(;r>e-t&&r%8!=0;)--r;for(;i<e+t&&(i+1)%8!=0;)i+=1;for(a=r;a<=i;){let e=a,r=a;for(n.add(a);e>a-t*8&&e-8>=0;)e-=8,n.add(e);for(;r<a+t*8&&r+8<64;)r+=8,n.add(r);a+=1}return[...n]}var S=[p,u,f],C=[d,m,h],w=class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.gameState=null}init(){this.loadGame()}checkCell(){this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addSaveGameListener(this.saveGame.bind(this)),this.gamePlay.addLoadGameListener(this.loadGame.bind(this)),this.gamePlay.addNewGameListener(this.newGame.bind(this))}onCellClick(e){let t=this.gameState.teams.find(t=>t.position===e);if(t&&t.character.player===a.USER){this.gameState.selectedHero&&this.gamePlay.deselectCell(this.gameState.selectedHero.position),this.gamePlay.selectCell(e),this.gameState.availableSteps=b(e,t.character.stepsRadius),this.gameState.availableAttack=x(e,t.character.attackRadius),this.gameState.selectedHero=t;return}if(this.gameState.selectedHero){this.gameState.availableSteps.includes(e)&&!t&&(this.gamePlay.deselectCell(this.gameState.selectedHero.position),this.gameState.selectedHero.position=e,this.gamePlay.deselectCell(e),this.checkLevel()),t&&t.character.player===a.COMP&&this.gameState.availableAttack.includes(e)&&this.attack(t,this.gameState.selectedHero,e),t&&t.character.player===a.COMP&&!this.gameState.availableAttack.includes(e)&&this.gamePlay.showPopup(`Нужно подойти ближе`);return}if(!this.gameState.selectedHero&&t&&t.character.player===a.COMP){let{type:e}=t.character;e=e[0].toUpperCase()+e.slice(1),this.gamePlay.showPopup(`Это ${e}! Он явно не из наших!`)}}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gameState.selectedHero&&this.gameState.selectedHero.position!==e&&this.gamePlay.deselectCell(e)}onCellEnter(e){let t=this.gameState.teams.find(t=>t.position===e);if(t){let n=this.constructor.createToolTipTemplate.call(this,t);this.gamePlay.showCellTooltip(n,e)}this.activeCursor(t),this.gameState.selectedHero&&this.activeCursorSelectedHero(e,t)}static createToolTipTemplate(e){let{level:t,health:n,attack:r,defence:i}=e.character;return`\u{1F396} ${t} \u{2694} ${r} \u{1F6E1} ${i} \u{2764} ${n}`}activeCursor(e){if(e){let t=e.character.player===a.USER?i.pointer:i.notallowed;this.gamePlay.setCursor(t)}else this.gamePlay.setCursor(i.auto)}activeCursorSelectedHero(e,t){this.gameState.availableSteps.includes(e)&&!t?(this.gamePlay.setCursor(i.pointer),this.gamePlay.selectCell(e,`green`)):t&&t.character.player===a.COMP&&this.gameState.availableAttack.includes(e)?(this.gamePlay.setCursor(i.crosshair),this.gamePlay.selectCell(e,`red`)):t&&t.character.player===a.USER?this.gamePlay.setCursor(i.pointer):this.gamePlay.setCursor(i.notallowed)}saveGame(){this.stateService.save(this.gameState),this.gamePlay.showPopup(`Игра сохранена`)}loadGame(){this.gamePlay.cellClickListeners.length===0&&this.checkCell();try{let e=this.stateService.load();e?(this.gameState=o.from(e),this.gamePlay.drawUi(Object.values(r)[this.gameState.stage-1]),this.gamePlay.redrawPositions(this.gameState.teams)):this.newGame()}catch(e){this.constructor.clearLocalStorage(`state`),this.gamePlay.showPopup(`Ошибка загрузки: "${e.message}"`),this.newGame()}}newGame(){this.gamePlay.cellClickListeners.length===0&&this.gamePlay.addCellClickListener(this.onCellClick.bind(this));let e=this.gameState?this.gameState.scores:0;this.gameState=new o(1,[],a.USER,e),this.nextStage(this.gameState.stage)}nextPlayer(){this.gameState.motion=this.gameState.motion===a.USER?a.COMP:a.USER,this.gameState.motion===a.COMP&&this.computerLogic(),this.gameState.clear()}checkLevel(){let e=this.gameState.teams.some(e=>e.character.player===a.USER),t=this.gameState.teams.some(e=>e.character.player===a.COMP);if(e&&t){this.nextPlayer();return}t||(this.gameState.clear(),this.gameState.addScores(),this.nextStage(this.gameState.stage+=1)),e||this.gamePlay.showPopup(`Вы проиграли! Попробуйте еще раз!`)}nextStage(e){if(e===1&&(this.constructor.teamGeneration.call(this,S,a.USER,1,2),this.constructor.teamGeneration.call(this,C,a.COMP,1,2)),e>1&&e<5){this.constructor.levelUp.call(this);let t=e===2?1:2;this.constructor.teamGeneration.call(this,S,a.USER,e-1,t);let n=this.gameState.teams.filter(e=>e.character.player===a.USER).length;this.constructor.teamGeneration.call(this,C,a.COMP,e,n),this.gamePlay.showPopup(`Уровень ${e} Счет: ${this.gameState.scores}`)}e>=5?(this.gamePlay.cellClickListeners.length=0,this.gamePlay.showPopup(`Победа! Игра окончена. Счет: ${this.gameState.scores}`)):(this.gamePlay.drawUi(Object.values(r)[this.gameState.stage-1]),this.gamePlay.redrawPositions(this.gameState.teams))}async attack(e,t,n){let{attack:r}=t.character,{defense:i}=e.character,a=e.character,o=2*Math.round(Math.max((r-i,r*.1)));a.health-=o,e.character.health<=0&&this.gameState.removeHero(n),this.gamePlay.selectCell(t.position),this.gamePlay.selectCell(e.position,`red`),this.gamePlay.redrawPositions(this.gameState.teams),this.gameState.selectedHero=null,await this.gamePlay.showDamage(n,o),this.gamePlay.deselectCell(t.position),this.gamePlay.deselectCell(e.position),this.checkLevel()}computerLogic(){let{teams:e}=this.gameState,t=e.filter(e=>e.character.player===a.COMP),n=e.filter(e=>e.character.player===a.USER);if(e.map(e=>e.position),!t.some(e=>{this.gameState.availableAttack=x(e.position,e.character.attackRadius);let t=n.find(e=>this.gameState.availableAttack.includes(e.position));return t?(this.attack(t,e,t.position),!0):!1})&&t.length&&n.length){let n=Math.floor(Math.random()*t.length),r=b(t[n].position,t[n].character.stepsRadius).filter(t=>e.map(e=>e.position).indexOf(t)<0),i=Math.floor(Math.random()*r.length);t[n].position=r[i],this.checkLevel(),this.gamePlay.redrawPositions(this.gameState.teams)}}static levelUp(){let e=[];for(let t of this.gameState.teams){let n=t.character;t.position=y(a.USER,e),n.level+=1,n.health=n.health+80>=100?100:n.health+80,n.attack=Math.floor(Math.max(n.attack,n.attack*(.8+n.health/100)))}e=[]}static teamGeneration(e,t,n,r){let i=v(e,n,r),a=[];this.gameState.teams.length&&this.gameState.teams.forEach(e=>a.push(e.position));let o=[];i=i.toArray.reduce((e,n)=>{let r=y(t,o);return a.push(r),e.push(new c(n,r)),e},[]),o=[],this.gameState.teams.push(...i)}static clearLocalStorage(e){localStorage.removeItem(e)}},T=class{constructor(e){this.storage=e}save(e){this.storage.setItem(`state`,JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem(`state`))}catch{throw Error(`Invalid state`)}}},E=new n;E.bindToDOM(document.querySelector(`#game-container`)),E.bindPopup(document.querySelector(`#popup`)),new w(E,new T(localStorage)).init();